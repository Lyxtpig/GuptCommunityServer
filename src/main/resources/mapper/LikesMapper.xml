<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="net.gupt.community.mapper.LikesMapper">
    <resultMap id="BaseResultMap" type="Likes">
        <id column="id" property="id" jdbcType="INTEGER"/>
        <result column="uid" property="uid" jdbcType="INTEGER"/>
        <result column="article_id" property="articleId" jdbcType="INTEGER"/>
        <result column="article_type" property="articleType" javaType="Byte"/>
        <result column="love_num" property="loveNum" javaType="int"/>
        <result column="view_num" property="viewNum" javaType="int"/>
    </resultMap>
    <sql id="Base_Column_List">
        id, uid, article_id,article_type,love_num,view_num
    </sql>
    <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.Integer">
        select
        <include refid="Base_Column_List"/>
        from tbl_likes
        where id = #{id,jdbcType=INTEGER}
    </select>
    <!--统计点赞数和浏览量-->
    <select id="findLikesWithView" resultType="Likes" resultMap="BaseResultMap">
        select sum(love_num) as love_num,sum(view_num) as view_num
        from tbl_likes
        where article_id = #{articleId} and article_type = #{articleType}
    </select>
    <!--点赞、浏览量插入-->
    <insert id="insertLikes" parameterType="Likes">
        insert into tbl_likes(uid, article_id, article_type, love_num, view_num)
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            #{uid},#{articleId},#{articleType},
            <choose>
                <when test="loveNum !=null and loveNum !=0" >
                    love_num +1,
                </when>
                <otherwise>
                    0,
                </otherwise>
            </choose>
            <choose>
                <when test="viewNum !=null and viewNum !=0">
                    view_num +1,
                </when>
                <otherwise>
                    0,
                </otherwise>
            </choose>
        </trim>
    </insert>
    <!--取消点赞-->
    <update id="deleteLikes">
        update
        tbl_likes
        set tbl_likes.love_num = love_num-1,tbl_likes.state = 1
        where article_id=#{articleId}
          and article_type=#{articleType}
          and uid  in (select tbl_student.uid from tbl_student where open_id = #{openId}
          and tbl_likes.state != 1
          )
    </update>

    <update id="updateByPrimaryKeySelective" parameterType="Likes">
        update tbl_likes
        <set>
            <if test="uid != null">
                uid = #{uid,jdbcType=INTEGER},
            </if>
            <if test="articleId != null">
                article_id = #{articleId,jdbcType=INTEGER},
            </if>
        </set>
        where id = #{id,jdbcType=INTEGER}
    </update>
    <update id="updateByPrimaryKey" parameterType="Likes">
        update tbl_likes
        set uid        = #{uid,jdbcType=INTEGER},
            article_id = #{articleId,jdbcType=INTEGER}
        where id = #{id,jdbcType=INTEGER}
    </update>
</mapper>